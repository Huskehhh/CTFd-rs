kind: pipeline
type: docker
name: default

steps:
- name: restore-cache-with-filesystem
  image: meltwater/drone-cache
  pull: true
  settings:
    backend: "filesystem"
    restore: true
    cache_key: "volume"
    archive_format: "gzip"
    filesystem_cache_root: "/cache"
    mount:
      - "target"

- name: build-and-test-rust
  image: registry.husk.pro/just-rust-docker:1.56
  environment:
    HTB_TEAM_ID:
      from_secret: HTB_TEAM_ID
    HTB_EMAIL:
      from_secret: HTB_EMAIL
    HTB_PASSWORD:
      from_secret: HTB_PASSWORD
  commands:
  - just check
  - just test
  depends_on: [ clone, restore-cache-with-filesystem ] 

- name: build-frontend
  image: node:16
  commands:
  - cd frontend
  - npm install
  - npm run build
  depends_on: [ clone ]

- name: rebuild-cache-with-filesystem
  image: meltwater/drone-cache
  pull: true
  depends_on: [ clone, build-and-test-rust ]
  settings:
    backend: "filesystem"
    rebuild: true
    cache_key: "volume"
    archive_format: "gzip"
    filesystem_cache_root: "/cache"    
    mount:
      - "target"

volumes:
  - name: cache
    host:
      path: /cache